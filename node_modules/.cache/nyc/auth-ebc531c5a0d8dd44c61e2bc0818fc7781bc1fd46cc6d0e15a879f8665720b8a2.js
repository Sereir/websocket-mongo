function cov_2jrq7ms2u6(){var path="C:\\Users\\Nacim\\Documents\\websocket-mongo\\src\\middleware\\auth.js";var hash="1c965203611d9d296c48a7c70445dd8ea0584d06";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\Nacim\\Documents\\websocket-mongo\\src\\middleware\\auth.js",statementMap:{"0":{start:{line:1,column:12},end:{line:1,column:35}},"1":{start:{line:2,column:13},end:{line:2,column:38}},"2":{start:{line:4,column:0},end:{line:28,column:2}},"3":{start:{line:5,column:2},end:{line:27,column:3}},"4":{start:{line:6,column:19},end:{line:6,column:53}},"5":{start:{line:7,column:28},end:{line:7,column:45}},"6":{start:{line:8,column:4},end:{line:10,column:5}},"7":{start:{line:9,column:6},end:{line:9,column:63}},"8":{start:{line:12,column:19},end:{line:12,column:41}},"9":{start:{line:13,column:4},end:{line:15,column:5}},"10":{start:{line:14,column:6},end:{line:14,column:74}},"11":{start:{line:17,column:20},end:{line:17,column:45}},"12":{start:{line:18,column:17},end:{line:18,column:63}},"13":{start:{line:19,column:4},end:{line:21,column:5}},"14":{start:{line:20,column:6},end:{line:20,column:63}},"15":{start:{line:23,column:4},end:{line:23,column:20}},"16":{start:{line:24,column:4},end:{line:24,column:11}},"17":{start:{line:26,column:4},end:{line:26,column:61}}},fnMap:{"0":{name:"auth",decl:{start:{line:4,column:32},end:{line:4,column:36}},loc:{start:{line:4,column:53},end:{line:28,column:1}},line:4}},branchMap:{"0":{loc:{start:{line:6,column:19},end:{line:6,column:53}},type:"binary-expr",locations:[{start:{line:6,column:19},end:{line:6,column:47}},{start:{line:6,column:51},end:{line:6,column:53}}],line:6},"1":{loc:{start:{line:8,column:4},end:{line:10,column:5}},type:"if",locations:[{start:{line:8,column:4},end:{line:10,column:5}},{start:{line:8,column:4},end:{line:10,column:5}}],line:8},"2":{loc:{start:{line:8,column:8},end:{line:8,column:37}},type:"binary-expr",locations:[{start:{line:8,column:8},end:{line:8,column:27}},{start:{line:8,column:31},end:{line:8,column:37}}],line:8},"3":{loc:{start:{line:13,column:4},end:{line:15,column:5}},type:"if",locations:[{start:{line:13,column:4},end:{line:15,column:5}},{start:{line:13,column:4},end:{line:15,column:5}}],line:13},"4":{loc:{start:{line:18,column:37},end:{line:18,column:62}},type:"binary-expr",locations:[{start:{line:18,column:37},end:{line:18,column:48}},{start:{line:18,column:52},end:{line:18,column:62}}],line:18},"5":{loc:{start:{line:19,column:4},end:{line:21,column:5}},type:"if",locations:[{start:{line:19,column:4},end:{line:21,column:5}},{start:{line:19,column:4},end:{line:21,column:5}}],line:19}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0},f:{"0":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"1c965203611d9d296c48a7c70445dd8ea0584d06"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_2jrq7ms2u6=function(){return actualCoverage;};}return actualCoverage;}cov_2jrq7ms2u6();const jwt=(cov_2jrq7ms2u6().s[0]++,require('jsonwebtoken'));const User=(cov_2jrq7ms2u6().s[1]++,require('../models/User'));cov_2jrq7ms2u6().s[2]++;module.exports=async function auth(req,res,next){cov_2jrq7ms2u6().f[0]++;cov_2jrq7ms2u6().s[3]++;try{const header=(cov_2jrq7ms2u6().s[4]++,(cov_2jrq7ms2u6().b[0][0]++,req.headers['authorization'])||(cov_2jrq7ms2u6().b[0][1]++,''));const[scheme,token]=(cov_2jrq7ms2u6().s[5]++,header.split(' '));cov_2jrq7ms2u6().s[6]++;if((cov_2jrq7ms2u6().b[2][0]++,scheme!=='Bearer')||(cov_2jrq7ms2u6().b[2][1]++,!token)){cov_2jrq7ms2u6().b[1][0]++;cov_2jrq7ms2u6().s[7]++;return res.status(401).json({error:'Token manquant'});}else{cov_2jrq7ms2u6().b[1][1]++;}const secret=(cov_2jrq7ms2u6().s[8]++,process.env.JWT_SECRET);cov_2jrq7ms2u6().s[9]++;if(!secret){cov_2jrq7ms2u6().b[3][0]++;cov_2jrq7ms2u6().s[10]++;return res.status(500).json({error:'Configuration JWT absente'});}else{cov_2jrq7ms2u6().b[3][1]++;}const payload=(cov_2jrq7ms2u6().s[11]++,jwt.verify(token,secret));const user=(cov_2jrq7ms2u6().s[12]++,await User.findById((cov_2jrq7ms2u6().b[4][0]++,payload.sub)||(cov_2jrq7ms2u6().b[4][1]++,payload.id)));cov_2jrq7ms2u6().s[13]++;if(!user){cov_2jrq7ms2u6().b[5][0]++;cov_2jrq7ms2u6().s[14]++;return res.status(401).json({error:'Token invalide'});}else{cov_2jrq7ms2u6().b[5][1]++;}cov_2jrq7ms2u6().s[15]++;req.user=user;cov_2jrq7ms2u6().s[16]++;next();}catch(err){cov_2jrq7ms2u6().s[17]++;return res.status(401).json({error:'Token invalide'});}};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMmpycTdtczJ1NiIsImFjdHVhbENvdmVyYWdlIiwiand0IiwicyIsInJlcXVpcmUiLCJVc2VyIiwibW9kdWxlIiwiZXhwb3J0cyIsImF1dGgiLCJyZXEiLCJyZXMiLCJuZXh0IiwiZiIsImhlYWRlciIsImIiLCJoZWFkZXJzIiwic2NoZW1lIiwidG9rZW4iLCJzcGxpdCIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsInNlY3JldCIsInByb2Nlc3MiLCJlbnYiLCJKV1RfU0VDUkVUIiwicGF5bG9hZCIsInZlcmlmeSIsInVzZXIiLCJmaW5kQnlJZCIsInN1YiIsImlkIiwiZXJyIl0sInNvdXJjZXMiOlsiYXV0aC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcclxuY29uc3QgVXNlciA9IHJlcXVpcmUoJy4uL21vZGVscy9Vc2VyJyk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uIGF1dGgocmVxLCByZXMsIG5leHQpIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgaGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXSB8fCAnJztcclxuICAgIGNvbnN0IFtzY2hlbWUsIHRva2VuXSA9IGhlYWRlci5zcGxpdCgnICcpO1xyXG4gICAgaWYgKHNjaGVtZSAhPT0gJ0JlYXJlcicgfHwgIXRva2VuKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVG9rZW4gbWFucXVhbnQnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XHJcbiAgICBpZiAoIXNlY3JldCkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0NvbmZpZ3VyYXRpb24gSldUIGFic2VudGUnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBheWxvYWQgPSBqd3QudmVyaWZ5KHRva2VuLCBzZWNyZXQpO1xyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQocGF5bG9hZC5zdWIgfHwgcGF5bG9hZC5pZCk7XHJcbiAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdUb2tlbiBpbnZhbGlkZScgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xyXG4gICAgbmV4dCgpO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdUb2tlbiBpbnZhbGlkZScgfSk7XHJcbiAgfVxyXG59O1xyXG4iXSwibWFwcGluZ3MiOiIwaEdBZVk7QUFBQUEsY0FBQSxTQUFBQSxDQUFBLFNBQUFDLGNBQUEsV0FBQUEsY0FBQSxFQUFBRCxjQUFBLEdBZlosS0FBTSxDQUFBRSxHQUFHLEVBQUFGLGNBQUEsR0FBQUcsQ0FBQSxNQUFHQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQ25DLEtBQU0sQ0FBQUMsSUFBSSxFQUFBTCxjQUFBLEdBQUFHLENBQUEsTUFBR0MsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEVBQUNKLGNBQUEsR0FBQUcsQ0FBQSxNQUV2Q0csTUFBTSxDQUFDQyxPQUFPLENBQUcsY0FBZSxDQUFBQyxJQUFJQSxDQUFDQyxHQUFHLENBQUVDLEdBQUcsQ0FBRUMsSUFBSSxDQUFFLENBQUFYLGNBQUEsR0FBQVksQ0FBQSxNQUFBWixjQUFBLEdBQUFHLENBQUEsTUFDbkQsR0FBSSxDQUNGLEtBQU0sQ0FBQVUsTUFBTSxFQUFBYixjQUFBLEdBQUFHLENBQUEsTUFBRyxDQUFBSCxjQUFBLEdBQUFjLENBQUEsU0FBQUwsR0FBRyxDQUFDTSxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUFmLGNBQUEsR0FBQWMsQ0FBQSxTQUFJLEVBQUUsR0FDakQsS0FBTSxDQUFDRSxNQUFNLENBQUVDLEtBQUssQ0FBQyxFQUFBakIsY0FBQSxHQUFBRyxDQUFBLE1BQUdVLE1BQU0sQ0FBQ0ssS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFDbEIsY0FBQSxHQUFBRyxDQUFBLE1BQzFDLEdBQUksQ0FBQUgsY0FBQSxHQUFBYyxDQUFBLFNBQUFFLE1BQU0sR0FBSyxRQUFRLElBQUFoQixjQUFBLEdBQUFjLENBQUEsU0FBSSxDQUFDRyxLQUFLLEVBQUUsQ0FBQWpCLGNBQUEsR0FBQWMsQ0FBQSxTQUFBZCxjQUFBLEdBQUFHLENBQUEsTUFDakMsTUFBTyxDQUFBTyxHQUFHLENBQUNTLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLENBQUVDLEtBQUssQ0FBRSxnQkFBaUIsQ0FBQyxDQUFDLENBQzFELENBQUMsS0FBQXJCLGNBQUEsR0FBQWMsQ0FBQSxVQUVELEtBQU0sQ0FBQVEsTUFBTSxFQUFBdEIsY0FBQSxHQUFBRyxDQUFBLE1BQUdvQixPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsVUFBVSxFQUFDekIsY0FBQSxHQUFBRyxDQUFBLE1BQ3RDLEdBQUksQ0FBQ21CLE1BQU0sQ0FBRSxDQUFBdEIsY0FBQSxHQUFBYyxDQUFBLFNBQUFkLGNBQUEsR0FBQUcsQ0FBQSxPQUNYLE1BQU8sQ0FBQU8sR0FBRyxDQUFDUyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQyxDQUFFQyxLQUFLLENBQUUsMkJBQTRCLENBQUMsQ0FBQyxDQUNyRSxDQUFDLEtBQUFyQixjQUFBLEdBQUFjLENBQUEsVUFFRCxLQUFNLENBQUFZLE9BQU8sRUFBQTFCLGNBQUEsR0FBQUcsQ0FBQSxPQUFHRCxHQUFHLENBQUN5QixNQUFNLENBQUNWLEtBQUssQ0FBRUssTUFBTSxDQUFDLEVBQ3pDLEtBQU0sQ0FBQU0sSUFBSSxFQUFBNUIsY0FBQSxHQUFBRyxDQUFBLE9BQUcsS0FBTSxDQUFBRSxJQUFJLENBQUN3QixRQUFRLENBQUMsQ0FBQTdCLGNBQUEsR0FBQWMsQ0FBQSxTQUFBWSxPQUFPLENBQUNJLEdBQUcsSUFBQTlCLGNBQUEsR0FBQWMsQ0FBQSxTQUFJWSxPQUFPLENBQUNLLEVBQUUsRUFBQyxFQUFDL0IsY0FBQSxHQUFBRyxDQUFBLE9BQzVELEdBQUksQ0FBQ3lCLElBQUksQ0FBRSxDQUFBNUIsY0FBQSxHQUFBYyxDQUFBLFNBQUFkLGNBQUEsR0FBQUcsQ0FBQSxPQUNULE1BQU8sQ0FBQU8sR0FBRyxDQUFDUyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQyxDQUFFQyxLQUFLLENBQUUsZ0JBQWlCLENBQUMsQ0FBQyxDQUMxRCxDQUFDLEtBQUFyQixjQUFBLEdBQUFjLENBQUEsVUFBQWQsY0FBQSxHQUFBRyxDQUFBLE9BRURNLEdBQUcsQ0FBQ21CLElBQUksQ0FBR0EsSUFBSSxDQUFDNUIsY0FBQSxHQUFBRyxDQUFBLE9BQ2hCUSxJQUFJLENBQUMsQ0FBQyxDQUNSLENBQUUsTUFBT3FCLEdBQUcsQ0FBRSxDQUFBaEMsY0FBQSxHQUFBRyxDQUFBLE9BQ1osTUFBTyxDQUFBTyxHQUFHLENBQUNTLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLENBQUVDLEtBQUssQ0FBRSxnQkFBaUIsQ0FBQyxDQUFDLENBQzFELENBQ0YsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==